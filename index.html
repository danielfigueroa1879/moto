<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ley de Tránsito Motos Chile</title>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CSS (for lupa, person, document, terminal, keyboard, variable, unit icons) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* Base Styles */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f8f8; /* Gris muy claro para el fondo */
            color: #333;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Evitar scroll horizontal */
            /* Background Image */
            background-image: url('fondo.png'); /* Ruta de la imagen de fondo */
            background-size: cover; /* Cubre todo el área */
            background-position: center; /* Centra la imagen */
            background-attachment: fixed; /* Fija la imagen al scroll */
        }

        /* Overlay for blurred background */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.5); /* Semi-transparent white overlay */
            backdrop-filter: blur(5px); /* Apply blur to the background */
            -webkit-backdrop-filter: blur(5px); /* For Safari compatibility */
            z-index: -1; /* Ensure it's behind the content but above the main body background */
        }


        /* Navbar Customization */
        .navbar-custom {
            background-color: #e0e0e0; /* Gris claro para el fondo de la navbar */
            transition: all 0.3s ease-in-out;
            padding: 1rem 3%; /* 3% de margen a los lados */
            border-bottom-left-radius: 10px; /* Esquinas redondeadas */
            border-bottom-right-radius: 10px; /* Esquinas redondeadas */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .navbar-custom .navbar-brand {
            font-weight: 700;
            color: #333; /* Color oscuro para que contraste con el gris claro */
            transition: font-size 0.3s ease-in-out;
        }

        .navbar-custom .nav-link {
            color: #333 !important; /* Texto de los enlaces en oscuro para que contraste */
            font-weight: 600; /* Negrita */
            position: relative;
            text-decoration: none; /* Quitar el subrayado predeterminado */
            transition: color 0.3s ease-in-out, text-decoration 0.3s ease-in-out;
            padding: 0.5rem 1rem;
            margin-left: 10px; /* Espacio entre elementos del navbar */
            border-radius: 5px;
        }

        .navbar-custom .nav-link:hover {
            color: #007bff !important; /* Azul al pasar el cursor */
        }

        .navbar-custom .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007bff; /* Azul para el subrayado */
            transition: width 0.3s ease-in-out;
        }

        .navbar-custom .nav-link:hover::after {
            width: 80%; /* Subrayado azul al pasar el cursor */
        }

        /* Navbar shrinking on scroll */
        .navbar-shrink {
            padding: 0.5rem 3%; /* Más pequeña al hacer scroll */
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }

        .navbar-shrink .navbar-brand {
            font-size: 1.2rem; /* Tamaño de fuente más pequeño para el logo */
        }

        /* Search Button and Bar */
        .search-toggler {
            background-color: #fff; /* Botón blanco */
            border: 2px solid #fff; /* Borde blanco */
            border-radius: 10px; /* Bordes redondeados */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Sombra sutil */
            padding: 0.5rem 0.8rem;
            transition: all 0.3s ease-in-out; /* Increased transition duration */
            margin-left: 10px;
        }

        .search-toggler:hover {
            transform: scale(1.08); /* Slightly larger scale */
        }

        .search-toggler i {
            color: #007bff; /* Color azul para la lupa */
            font-size: 1.2rem;
        }

        .search-bar-container {
            position: absolute;
            top: 100%; /* Debajo de la navbar */
            left: 0;
            width: 100%;
            background-color: #e0e0e0; /* Mismo color que la navbar */
            padding: 10px 3%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            display: none; /* Oculto por defecto */
            z-index: 1000;
        }

        .search-bar-container.show {
            display: block;
        }

        .search-bar-container input {
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ccc;
            padding: 8px;
            font-family: 'Poppins', sans-serif;
        }

        /* Contact Button */
        .contact-btn {
            background-color: #fff; /* Botón blanco */
            border: 2px solid #fff; /* Borde blanco */
            border-radius: 10px; /* Bordes redondeados */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Sombra sutil */
            padding: 0.5rem 0.8rem;
            transition: all 0.3s ease-in-out; /* Increased transition duration */
            margin-left: 10px;
        }

        .contact-btn:hover {
            transform: scale(1.08); /* Slightly larger scale */
        }

        .contact-btn i {
            color: #007bff; /* Color azul para el ícono de persona */
            font-size: 1.2rem;
        }

        /* Mobile Menu Toggle (Hamburger) */
        .navbar-toggler {
            border: none;
            padding: 0;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%280,0,0,1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        /* Main Content Area */
        .main-content {
            padding: 20px 8%; /* Márgenes del 8% a los lados */
            text-align: justify; /* Texto justificado */
            line-height: 1.6; /* Espaciado simple entre líneas */
            color: #333;
        }

        /* New info-section style for white containers */
        .info-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }


        .main-content h1, .main-content h2, .main-content h3,
        .main-content h4, .main-content h5, .main-content h6 {
            font-weight: 700; /* Negrita */
            font-size: 1.8rem; /* Un poco más grande */
            margin-top: 1.5em; /* Más espacio entre párrafos para encabezados */
            margin-bottom: 0.8em;
            text-align: center;
            color: #007bff; /* Color azul para los encabezados */
        }

        .main-content p {
            margin-bottom: 1.5em; /* Más espacio entre párrafos */
        }

        .main-content a {
            font-weight: bold; /* Enlaces en negrita */
            color: inherit; /* Mismo color que el texto normal */
            text-decoration: none; /* Quitar subrayado por defecto */
            position: relative;
            transition: color 0.3s ease-in-out;
        }

        .main-content a:hover {
            color: #007bff; /* Azul al pasar el cursor */
            text-decoration: underline; /* Subrayado al pasar el cursor */
        }

        /* Images */
        .main-content img {
            max-width: 100%; /* Adaptadas al ancho de la columna */
            height: auto;
            display: block;
            margin: 20px auto; /* Centrar imágenes */
            border-radius: 10px; /* Bordes redondeados */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra sutil */
        }

        .image-caption {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            margin-bottom: 20px;
        }

        /* Lists */
        .main-content ul {
            list-style: none; /* Eliminar viñetas predeterminadas */
            padding-left: 0;
        }

        .main-content ul li {
            position: relative;
            padding-left: 25px; /* Espacio para la viñeta personalizada */
            margin-bottom: 0.5em;
        }

        .main-content ul li::before {
            content: "\2023"; /* Unicode para un triángulo (o puedes usar un SVG para una una flecha) */
            font-size: 1em;
            color: #007bff; /* Color azul para las viñetas */
            position: absolute;
            left: 0;
            top: 0.1em;
        }

        /* Blockquotes */
        .main-content blockquote {
            background-color: rgba(173, 216, 230, 0.3); /* Azul suave semi-transparente */
            border-left: 5px solid #007bff; /* Borde azul a la izquierda */
            margin: 20px 0;
            padding: 15px 20px;
            border-radius: 8px; /* Bordes redondeados */
            font-style: italic;
            color: #555;
        }

        /* Videos */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            margin: 20px auto;
            border-radius: 10px; /* Bordes redondeados */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 100%;
        }

        .video-container iframe,
        .video-container object,
        .video-container embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px; /* Bordes redondeados también en el iframe */
        }

        /* Icons for special elements (document, variable, keyboard, terminal) */
        .icon-small {
            font-size: 0.9em;
            vertical-align: middle;
            margin-right: 5px;
            color: #007bff; /* Azul para los íconos pequeños */
        }

        /* New style for the dynamically created PWA install banner */
        #dynamic-install-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(128, 128, 128, 0.6); /* Fondo gris semi-transparente */
            color: white; /* Letra blanca */
            font-weight: bold; /* Letra en negrita */
            padding: 20px; /* Aumenta el padding vertical */
            text-align: center;
            z-index: 1000;
            display: none; /* Hidden by default on PC */
            justify-content: center; /* Center content horizontally with flex */
            align-items: center; /* Center content vertically with flex */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Sombra sutil */
        }

        #dynamic-install-banner button {
            margin-left: 10px;
            padding: 8px 16px;
            background: white;
            color: #0a73c3; /* Color azul para el texto del botón */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #dynamic-install-banner button:hover {
            background-color: #f0f0f0; /* Ligeramente más oscuro al pasar el cursor */
            transform: translateY(-1px);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            background-color: #333;
            color: #f8f8f8;
            font-size: 0.9em;
            margin-top: 50px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        /* Exam Section Styles */
        #exam-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 40px;
            text-align: center; /* Center content of exam section */
        }

        #start-exam-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        #start-exam-btn:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }

        #quiz-container {
            /* display: none; */ /* Removed from here, handled by JS function */
            text-align: left; /* Questions aligned left within their container */
        }

        .question-card {
            background-color: #f4f4f4;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .question-card h5 { /* Estilo para las preguntas del examen */
            color: #333; /* Color negro */
            font-weight: 700; /* Negrita */
            font-size: 1.1em; /* Tamaño por defecto para PC */
            text-align: justify; /* Justificado */
            margin-bottom: 15px;
        }
        
        .question-card .form-check-label { /* Estilo para las alternativas */
            cursor: pointer;
            padding-left: 5px;
            font-weight: normal; /* No negrita para las alternativas */
            color: #333; /* Color negro para las alternativas */
        }

        .exam-controls {
            text-align: center;
            margin-top: 30px;
        }

        .exam-controls button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .exam-controls button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        #exam-results {
            background-color: #e6f7ff;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: none;
        }

        #exam-results h3 {
            color: #007bff;
        }

        #exam-results p {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* AI Clarifier Section */
        #ai-clarifier-section {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        #ai-clarifier-section textarea {
            width: 100%;
            height: 100px;
            border-radius: 8px;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            margin-bottom: 15px;
        }

        #ai-clarifier-section button {
            background-color: #28a745; /* Verde para el botón de IA */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #ai-clarifier-section button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        #ai-clarifier-response {
            background-color: #f0fdf4; /* Fondo verde muy claro para la respuesta */
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #d4edda;
            white-space: pre-wrap; /* Para mantener el formato de la respuesta del LLM */
        }

        /* Modal for Install Button (now removed from HTML, only for reference if needed elsewhere) */
        .install-modal-overlay {
            display: none; /* Always hidden now as it's not used */
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            /* Show dynamic install banner on mobile */
            #dynamic-install-banner {
                display: flex; /* Show using flexbox for centering */
            }

            .navbar-custom {
                padding: 1rem 5%;
            }
            .navbar-custom .navbar-brand {
                font-size: 1.5rem;
            }
            .navbar-custom .navbar-collapse {
                background-color: #e0e0e0; /* Fondo para el menú colapsado */
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .navbar-custom .nav-link {
                text-align: center;
                margin: 5px 0;
            }
            .navbar-custom .nav-link::after {
                width: 50%; /* Subrayado más corto en móvil */
            }
            /* Adjusted main content padding for mobile */
            .main-content {
                padding: 15px 2%; /* Margen del 2% a los lados en móviles */
            }
            .main-content h1, .main-content h2, .main-content h3,
            .main-content h4, .main-content h5, .main-content h6 {
                font-size: 1.5rem; /* Encabezados más pequeños en móvil */
            }
            #install-banner p {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            #install-button {
                padding: 8px 15px;
            }
            .install-modal-content {
                padding: 20px;
            }
            /* Adjust exam question font size for small screens */
            .question-card h5 {
                font-size: 0.9em; /* Smaller font size for question text on mobile */
            }
            /* Adjust alternative font size for small screens */
            .question-card .form-check-label {
                font-size: 0.8em; /* Smaller font size for alternatives on mobile */
            }
        }

        @media (min-width: 769px) { /* Hide dynamic install banner on PC */
            #dynamic-install-banner {
                display: none !important; /* Hide on larger screens, !important to override JS flex */
            }
        }
    </style>
</head>
<body>

    <!-- Background Overlay for blur effect -->
    <div class="background-overlay"></div>

    <!-- Installation Modal (kept for reference, but display: none in CSS) -->
    <div id="install-modal" class="install-modal-overlay">
        <div class="install-modal-content">
            <h4>¡Instala esta Web App!</h4>
            <p>Para añadir esta página a tu pantalla de inicio y usarla como una aplicación, sigue estos pasos:</p>
            <p><strong>En Android:</strong> Toca el icono de menú (generalmente 3 puntos) en tu navegador y selecciona "Añadir a pantalla de inicio".</p>
            <p><strong>En iOS (iPhone/iPad):</strong> Toca el icono de "Compartir" (el cuadrado con una flecha hacia arriba) en tu navegador y selecciona "Añadir a pantalla de inicio".</p>
            <button id="close-install-modal">Entendido</button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom fixed-top" id="mainNavbar">
        <div class="container-fluid px-3">
            <a class="navbar-brand" href="#">Ley Tránsito Motos</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#exam-section">Examen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#ai-clarifier-section">Clarificador IA</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#leyes">Leyes y normativas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#interes">Links de interés</a>
                    </li>
                    <li class="nav-item d-flex align-items-center">
                        <button class="search-toggler" id="searchToggle">
                            <i class="bi bi-search"></i>
                        </button>
                    </li>
                    <li class="nav-item d-flex align-items-center">
                        <a class="contact-btn" href="#contacto">
                            <i class="bi bi-person"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Search Bar that expands -->
        <div class="search-bar-container" id="searchBar">
            <input type="text" placeholder="Buscar en la página..." aria-label="Search">
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="main-content mt-5 pt-5">
        <h1 class="text-center">¡Bienvenido a la Plataforma de Ley de Tránsito para Motociclistas en Chile!</h1>
        <p>Esta plataforma ha sido diseñada para ofrecerte información relevante y actualizada sobre la Ley de Tránsito chilena, con un enfoque especial en la normativa aplicable a motocicletas. Nuestro objetivo es ayudarte a comprender mejor tus derechos y deberes como conductor, promoviendo una conducción segura y responsable en las vías públicas.</p>

        <!-- Exam Section -->
        <section id="exam-section" class="mt-5">
            <h2 class="text-center">Examen de Ley de Tránsito para Motociclistas</h2>
            <p class="text-center">Pon a prueba tus conocimientos sobre la Ley de Tránsito chilena, con preguntas enfocadas en la normativa de motos. ¡Obtén tu calificación en escala del 1 al 7!</p>
            
            <button id="start-exam-btn" class="mb-4">Empezar Examen Ahora</button>

            <div id="quiz-container" class="mt-4">
                <!-- Questions will be loaded here by JavaScript -->
                <p class="text-center">Cargando preguntas del examen...</p>
            </div>
            <div class="exam-controls">
                <button id="submit-quiz-btn" style="display: none;">Enviar Examen</button>
            </div>
            <div id="exam-results" class="mt-4">
                <!-- Exam results will be displayed here -->
            </div>
        </section>

        <!-- AI Legal Clarifier Section -->
        <section id="ai-clarifier-section" class="mt-5">
            <h2 class="text-center">Clarificador Legal con IA (Pregúntale a Gemini)</h2>
            <p class="text-center">¿Tienes dudas sobre algún artículo de la Ley de Tránsito o una normativa específica para motociclistas? Escribe tu pregunta a continuación y nuestra inteligencia artificial te proporcionará una explicación clara.</p>
            <img src="gemini.png" alt="Logo de Gemini IA" class="gemini-logo" style="float: right; width: 80px; height: auto; margin-left: 15px; margin-bottom: 10px;">
            <textarea id="ai-question-input" placeholder="Ej: ¿Qué dice la Ley 18.290 sobre el uso del chaleco reflectante en motos?"></textarea>
            <button id="ask-ai-btn">Preguntar a la IA</button>
            <div id="ai-clarifier-response" class="mt-3">
                <p>Tu respuesta aparecerá aquí.</p>
            </div>
        </section>

        <section class="info-section">
            <h2 id="leyes">Leyes y Normativas Clave (Ley 18.290 y más)</h2>
            <p>La Ley de Tránsito Nº 18.290 es el cuerpo legal fundamental que regula el uso de las vías públicas en Chile. A continuación, exploraremos algunos de sus puntos más importantes, así como otras normativas específicas para motociclistas.</p>

            <h3>Uso de Casco y Elementos de Seguridad</h3>
            <p>El uso del casco protector es obligatorio para todos los motociclistas y sus acompañantes. Este debe ser un casco reglamentario, certificado y abrochado correctamente. La normativa también exige el uso de otros elementos de seguridad.</p>
            
            <div class="text-center my-4">
                <a href="https://www.conaset.cl/ley-de-convivencia/" target="_blank" class="btn btn-primary btn-lg">Ver la página completa de Leyes y Normativas</a>
            </div>

            <p>Algunos puntos importantes a recordar sobre la seguridad vial en moto:</p>
            <ul>
                <li><i class="icon-small bi bi-triangle-fill"></i> El casco debe estar homologado y en buenas condiciones.</li>
                <li><i class="icon-small bi bi-triangle-fill"></i> Usar guantes, chaqueta con protecciones y calzado adecuado.</li>
                <li><i class="icon-small bi bi-triangle-fill"></i> Mantener las luces encendidas día y noche.</li>
            </ul>

            <h3>Velocidad y Distancia de Seguridad</h3>
            <p>Respetar los límites de velocidad y mantener una distancia de seguridad adecuada es crucial para evitar accidentes. La <abbr title="Ley de Tránsito" class="text-primary">LT</abbr> establece sanciones para quienes no cumplan con estas disposiciones. Por ejemplo, la velocidad máxima en zonas urbanas es de 50 <i class="icon-small bi bi-speedometer"></i> km/h.</p>

            <blockquote>
                <p>Como indica el artículo 144 de la Ley de Tránsito: "La velocidad en zonas urbanas no podrá exceder de 50 kilómetros por hora."</p>
                <p class="text-end fst-italic"> Ejemplo de cita en bloque </p>
            </blockquote>

            <p>El cálculo de la distancia de seguridad puede variar dependiendo de las condiciones climáticas y del estado de la vía. Una <var class="text-primary">fórmula</var> básica para estimar la distancia en segundos es la "regla de los tres segundos".</p>

            <h3>Maniobras y Adelantamientos</h3>
            <p>Las motocicletas deben realizar los adelantamientos y virajes con especial precaución, respetando las señales y las normas de tránsito. <kbd class="text-primary">Ctrl</kbd> + <kbd class="text-primary">Alt</kbd> + <kbd class="text-primary">Del</kbd> no se aplica aquí, pero la atención constante es vital.</p>

            <pre><code>
                // Ejemplo de código para cálculo de distancia (solo ilustrativo)
                function calcularDistanciaSeguridad(velocidad_kmh) {
                    let velocidad_ms = velocidad_kmh * 1000 / 3600;
                    let distancia_reaccion = velocidad_ms * 1; // 1 segundo de reacción
                    let distancia_frenado = (velocidad_ms * velocidad_ms) / (2 * 9.8 * 0.7); // Ejemplo básico
                    return distancia_reaccion + distancia_frenado;
                }
                // console.log(calcularDistanciaSeguridad(60)); // Salida de programa <i class="icon-small bi bi-terminal"></i>
            </code></pre>
            <p>La <mark>seguridad</mark> es primordial en cada trayecto. Evite maniobras bruscas.</p>
        </section>

        <section class="info-section">
            <h2 id="interes">Links de Interés</h2>
            <p>Aquí encontrarás enlaces a recursos útiles para complementar tu conocimiento sobre la ley de tránsito y la conducción de motocicletas.</p>
            <ul>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.conaset.cl/" target="_blank">CONASET (Comisión Nacional de Seguridad de Tránsito)</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://www.bcn.cl/leychile/navegar?i=29708" target="_blank">Ley de Tránsito 18.290 - Biblioteca del Congreso Nacional</a></li>
                <li><i class="icon-small bi bi-link"></i> <a href="https://practicatest.cl/blog/normativa-de-transito/como-adelantar-con-motocicleta" target="_blank">Artículo: Cómo adelantar con motocicleta - Practicatest Chile</a></li>
            </ul>

            <div style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; margin: 20px auto; display: flex; justify-content: center; align-items: center; background-color: #f0f0f0;">
                <p style="color: #666;">Mapa de referencia (sin interactividad)</p>
            </div>

            <h3>Documentos y Recursos Descargables</h3>
            <p>Próximamente, podrás descargar documentos importantes relacionados con la ley de tránsito.</p>
            <!-- Removed: <p><i class="icon-small bi bi-file-earmark-text"></i> <a href="#" download>Manual de Conducción para Motociclistas (PDF)</a></p> -->

            <h3>Videos Educativos</h3>
            <p>Más adelante, encontrarás una sección con videos tutoriales sobre técnicas de conducción segura y explicaciones de la ley.</p>
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
        </section>

        <section class="info-section">
            <h2 id="contacto">Contacto</h2>
            <p>Si tienes preguntas o necesitas más información, no dudes en contactarnos. Estamos aquí para ayudarte a ser un conductor más seguro y mejor informado.</p>
            <address class="text-center">
                <strong>Daniel Elías Figueroa Chacama</strong><br>
                Ingeniero en Informática<br>
                Chile
            </address>
        </section>
    </div>

    <footer class="footer">
        <p>Plataforma creada por Daniel Elías Figueroa Chacama, Ingeniero en Informática.</p>
        <p>© 2025 Todos los derechos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let deferredInstallPrompt = null; // Variable para almacenar el evento beforeinstallprompt

        document.addEventListener('DOMContentLoaded', function() {
            // Navbar Shrink on Scroll
            const navbar = document.getElementById('mainNavbar');
            window.addEventListener('scroll', function() {
                if (window.scrollY > 50) {
                    navbar.classList.add('navbar-shrink');
                } else {
                    navbar.classList.remove('navbar-shrink');
                }
            });

            // Search Bar Toggle
            const searchToggle = document.getElementById('searchToggle');
            const searchBar = document.getElementById('searchBar');

            searchToggle.addEventListener('click', function() {
                searchBar.classList.toggle('show');
            });

            // Hide search bar if clicked outside
            document.addEventListener('click', function(event) {
                if (!searchBar.contains(event.target) && !searchToggle.contains(event.target)) {
                    searchBar.classList.remove('show');
                }
            });

            // --- PWA Install Banner Logic (Dynamically created) ---
            let dynamicInstallBanner = null; // To hold the dynamically created banner element
            let bannerTimeout; // To hold the timeout for the banner removal

            // Listen for the beforeinstallprompt event (PWA installation)
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); // Prevent the mini-infobar from appearing on mobile
                deferredInstallPrompt = e; // Stash the event so it can be triggered later.
                
                // If the banner doesn't exist yet and it's a mobile device (or small screen)
                if (!dynamicInstallBanner && window.matchMedia('(max-width: 768px)').matches && !window.matchMedia('(display-mode: standalone)').matches) {
                    dynamicInstallBanner = document.createElement('div');
                    dynamicInstallBanner.id = 'dynamic-install-banner'; // Assign an ID for CSS targeting
                    dynamicInstallBanner.innerHTML = `
                        ¿Quieres instalar esta app? 
                        <button>Instalar</button>
                    `;
                    document.body.appendChild(dynamicInstallBanner);

                    // Add click listener for the dynamically created button
                    dynamicInstallBanner.querySelector('button').addEventListener('click', () => {
                        clearTimeout(bannerTimeout); // Cancel the timeout
                        if (deferredInstallPrompt) {
                            deferredInstallPrompt.prompt();
                            deferredInstallPrompt.userChoice.then((choiceResult) => {
                                if (choiceResult.outcome === 'accepted') {
                                    console.log('Usuario aceptó la instalación');
                                } else {
                                    console.log('Usuario rechazó la instalación');
                                }
                                deferredInstallPrompt = null; // Prompt has been used
                                if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                                    dynamicInstallBanner.remove(); // Remove the banner after user interaction
                                }
                            });
                        } else {
                            console.log('deferredPrompt no disponible. El navegador no mostró el prompt de instalación.');
                            if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                                dynamicInstallBanner.remove(); // Remove the banner even if prompt is not available
                            }
                        }
                    });

                    // Set a timeout to remove the banner after 10 seconds
                    bannerTimeout = setTimeout(() => {
                        if (dynamicInstallBanner && dynamicInstallBanner.parentNode) { // Check if banner still exists
                            dynamicInstallBanner.remove();
                            console.log('Banner de instalación eliminado después de 10 segundos.');
                        }
                    }, 10000); // 10,000 milliseconds = 10 seconds

                    // Optional: Hide the banner if the user scrolls (common behavior for PWA banners)
                    window.addEventListener('scroll', () => {
                        if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                            dynamicInstallBanner.remove();
                            clearTimeout(bannerTimeout);
                            console.log('Banner de instalación eliminado por scroll.');
                        }
                    }, { once: true }); // Only listen for the first scroll event
                }
                console.log('beforeinstallprompt event fired. PWA is installable.');
            });

            // Listen for the appinstalled event
            window.addEventListener('appinstalled', () => {
                // Hide the install button/banner when the app is installed
                if (dynamicInstallBanner && dynamicInstallBanner.parentNode) {
                    dynamicInstallBanner.remove();
                }
                console.log('PWA was successfully installed.');
            });

            // --- Exam Logic ---
            const quizContainer = document.getElementById('quiz-container');
            const submitQuizBtn = document.getElementById('submit-quiz-btn');
            const examResults = document.getElementById('exam-results');
            const startExamBtn = document.getElementById('start-exam-btn'); // New button

            // Hide quiz container initially in JavaScript, overriding CSS (if present)
            // This ensures it's hidden before the button is clicked
            quizContainer.style.display = 'none'; 

            // Fallback questions in case Gemini API fails or takes too long
            const defaultQuestions = [
                {
                    question: "¿Cuál es la velocidad máxima permitida para motocicletas en zonas urbanas de Chile, según la Ley de Tránsito?",
                    options: ["A) 60 km/h", "B) 50 km/h", "C) 70 km/h", "D) 40 km/h"],
                    correctAnswer: "B) 50 km/h"
                },
                {
                    question: "¿Es obligatorio el uso de chaleco reflectante para motociclistas en Chile durante la noche?",
                    options: ["A) Sí, siempre", "B) No, solo si se circula en autopistas", "C) Sí, entre la puesta y la salida del sol", "D) Solo para motocicletas de más de 250cc"],
                    correctAnswer: "C) Sí, entre la puesta y la salida del sol"
                },
                {
                    question: "¿Qué tipo de licencia de conducir se requiere para manejar una motocicleta en Chile?",
                    options: ["A) Clase B", "B) Clase C", "C) Clase A2", "D) Clase D"],
                    correctAnswer: "B) Clase C"
                },
                {
                    question: "Según la Ley de Tránsito, ¿cuántos pasajeros puede transportar una motocicleta, si su diseño lo permite?",
                    options: ["A) Solo al conductor", "B) El conductor y un acompañante", "C) El conductor y dos acompañantes", "D) Depende del cilindraje"],
                    correctAnswer: "B) El conductor y un acompañante"
                },
                {
                    question: "¿Está permitido para un motociclista adelantar entre vehículos que circulan en la misma pista en Chile?",
                    options: ["A) Sí, siempre y cuando sea seguro", "B) No, está prohibido", "C) Solo si el tráfico está detenido", "D) Solo si la velocidad es muy baja"],
                    correctAnswer: "B) No, está prohibido"
                },
                {
                    question: "¿Cuál es la sanción por conducir una motocicleta sin la licencia de conducir correspondiente en Chile?",
                    options: ["A) Multa leve", "B) Multa grave y suspensión de licencia", "C) Amonestación verbal", "D) Solo retención del vehículo"],
                    correctAnswer: "B) Multa grave y suspensión de licencia"
                },
                {
                    question: "¿Qué documento debe portar obligatoriamente el conductor de una motocicleta en Chile, además de su licencia de conducir?",
                    options: ["A) Permiso de circulación", "B) Recibo de bencina", "C) Comprobante de la última revisión técnica", "D) Tarjeta de crédito"],
                    correctAnswer: "A) Permiso de circulación"
                },
                {
                    question: "En caso de accidente con una motocicleta, ¿quién tiene la obligación de dar aviso a la autoridad policial?",
                    options: ["A) Solo los conductores involucrados", "B) Cualquier persona que presencie el accidente", "C) Solo los paramédicos", "D) La compañía de seguros"],
                    correctAnswer: "A) Solo los conductores involucrados"
                },
                {
                    question: "¿Se permite que una motocicleta circule por la berma en autopistas o carreteras en Chile?",
                    options: ["A) Sí, para evitar congestión", "B) No, bajo ninguna circunstancia", "C) Solo en caso de emergencia", "D) Si va a una velocidad menor a 20 km/h"],
                    correctAnswer: "B) No, bajo ninguna circunstancia"
                },
                {
                    question: "¿Es necesario que las motocicletas pasen por la revisión técnica vehicular en Chile?",
                    options: ["A) No, solo los automóviles", "B) Sí, anualmente", "C) Solo cada dos años", "D) Solo si tienen más de 5 años de antigüedad"],
                    correctAnswer: "B) Sí, anualmente"
                },
                {
                    question: "Si un motociclista se ve involucrado en un accidente con lesionados, ¿cuál es su primera obligación?",
                    options: ["A) Abandonar el lugar", "B) Prestar auxilio a los heridos", "C) Llamar a su seguro", "D) Mover el vehículo de la vía"],
                    correctAnswer: "B) Prestar auxilio a los heridos"
                },
                {
                    question: "¿Cuál es la principal función del espejo retrovisor en una motocicleta?",
                    options: ["A) Peinarse", "B) Ver los vehículos de atrás", "C) Evitar los puntos ciegos", "D) Ver la rueda trasera"],
                    correctAnswer: "B) Ver los vehículos de atrás"
                },
                {
                    question: "¿Está permitido para un motociclista el uso de audífonos mientras conduce?",
                    options: ["A) Sí, siempre que no sea a un volumen alto", "B) No, está prohibido", "C) Solo si son inalámbricos", "D) Solo para GPS"],
                    correctAnswer: "B) No, está prohibido"
                },
                {
                    question: "¿Qué tipo de luces debe llevar encendidas una motocicleta durante el día?",
                    options: ["A) Ninguna", "B) Luces bajas", "C) Luces altas", "D) Luces de posición"],
                    correctAnswer: "B) Luces bajas"
                },
                {
                    question: "¿Cuál es la edad mínima para obtener licencia clase C en Chile?",
                    options: ["A) 16 años", "B) 17 años", "C) 18 años", "D) 20 años"],
                    correctAnswer: "C) 18 años"
                },
                {
                    question: "Si la motocicleta tiene un asiento para acompañante, ¿es obligatorio que este use casco?",
                    options: ["A) No, solo el conductor", "B) Sí, siempre", "C) Solo si es menor de edad", "D) Depende de la velocidad"],
                    correctAnswer: "B) Sí, siempre"
                },
                {
                    question: "¿Qué significa la demarcación de una línea continua amarilla en la calzada?",
                    options: ["A) Se puede adelantar", "B) Prohibido adelantar", "C) Estacionamiento permitido", "D) Carril exclusivo"],
                    correctAnswer: "B) Prohibido adelantar"
                },
                {
                    question: "¿Un motociclista puede circular por la acera o vereda?",
                    options: ["A) Sí, si no hay peatones", "B) No, está prohibido", "C) Solo para estacionar", "D) Si va a una velocidad muy reducida"],
                    correctAnswer: "B) No, está prohibido"
                },
                {
                    question: "¿Cuál es la sanción por no usar el casco protector reglamentario en motocicleta?",
                    options: ["A) Amonestación verbal", "B) Multa leve", "C) Multa grave", "D) Suspensión de licencia"],
                    correctAnswer: "C) Multa grave"
                },
                {
                    question: "¿Qué se debe hacer si se encuentra con un semáforo en luz amarilla?",
                    options: ["A) Acelerar para pasar", "B) Detenerse antes de la intersección", "C) Continuar con precaución", "D) Tocar la bocina"],
                    correctAnswer: "B) Detenerse antes de la intersección"
                },
                {
                    question: "¿Es obligatorio el uso de luces de viraje para motocicletas en Chile?",
                    options: ["A) No, con la mano es suficiente", "B) Sí, siempre que se vaya a virar", "C) Solo de noche", "D) Solo en carretera"],
                    correctAnswer: "B) Sí, siempre que se vaya a virar"
                },
                {
                    question: "¿Cuál es la importancia de la patente en una motocicleta?",
                    options: ["A) Es un adorno", "B) Identifica al vehículo legalmente", "C) No es importante", "D) Sirve para la velocidad"],
                    correctAnswer: "B) Identifica al vehículo legalmente"
                },
                {
                    question: "¿Se permite conducir una motocicleta bajo los efectos del alcohol en Chile?",
                    options: ["A) Sí, if es poco", "B) No, bajo ninguna circunstancia", "C) Solo en zonas rurales", "D) Depende de la hora del día"],
                    correctAnswer: "B) No, bajo ninguna circunstancia"
                },
                {
                    question: "¿Qué indica una señal de tránsito octogonal con el borde rojo y la palabra 'PARE' en blanco?",
                    options: ["A) Ceda el paso", "B) Detención obligatoria", "C) Prohibido estacionar", "D) Fin de restricción"],
                    correctAnswer: "B) Detención obligatoria"
                },
                {
                    question: "¿Cuál es la profundidad mínima legal del dibujo de los neumáticos de una motocicleta?",
                    options: ["A) 0.5 mm", "B) 1.6 mm", "C) 2.0 mm", "D) No hay mínimo"],
                    correctAnswer: "B) 1.6 mm"
                },
                {
                    question: "¿Es necesario tener un seguro obligatorio (SOAP) para circular en motocicleta en Chile?",
                    options: ["A) No, es opcional", "B) Sí, es obligatorio anualmente", "C) Solo si la moto es nueva", "D) Solo si la moto es antigua"],
                    correctAnswer: "B) Sí, es obligatorio anualmente"
                },
                {
                    question: "¿Dónde debe estacionarse una motocicleta en la vía pública?",
                    options: ["A) En cualquier lugar", "B) Solo en lugares habilitados para ello", "C) Sobre la acera", "D) En medio de la calzada"],
                    correctAnswer: "B) Solo en lugares habilitados para ello"
                },
                {
                    question: "¿Qué debe hacer un motociclista antes de iniciar la marcha?",
                    options: ["A) Tocar la bocina", "B) Revisar los espejos y señalizar", "C) Encender las luces altas", "D) Acelerar bruscamente"],
                    correctAnswer: "B) Revisar los espejos y señalizar"
                },
                {
                    question: "¿Está permitido circular en motocicleta con el escape libre o modificado que produzca ruidos excesivos?",
                    options: ["A) Sí, para ser más visible", "B) No, está prohibido", "C) Solo en zonas rurales", "D) Si es de baja cilindrada"],
                    correctAnswer: "B) No, está prohibido"
                },
                {
                    question: "Si un motociclista sufre un desperfecto en la vía, ¿qué debe hacer?",
                    options: ["A) Dejar la moto en la calzada", "B) Señalizar y moverla a un lugar seguro si es posible", "C) Esperar dentro del carril", "D) Apagar las luces"],
                    correctAnswer: "B) Señalizar y moverla a un lugar seguro si es posible"
                }
            ];

            let questions = []; // This will hold the questions generated by Gemini or default ones

            // Function to generate questions using Gemini API
            async function generateQuestions() {
                // Show loading message inside quiz container
                quizContainer.innerHTML = '<p class="text-center text-info">Generando preguntas con IA... Esto puede tardar unos segundos.</p>';
                quizContainer.style.display = 'block'; // Make quiz container visible immediately
                startExamBtn.style.display = 'none'; // Hide the start button

                const prompt = "Genera 30 preguntas de opción múltiple sobre la Ley de Tránsito de Chile (Ley 18.290), enfocadas en normativas para motocicletas. Cada pregunta debe tener 4 opciones (A, B, C, D) y una única respuesta correcta. El formato debe ser un arreglo de objetos JSON, donde cada objeto tenga 'question', 'options' (un arreglo de strings) y 'correctAnswer' (el string de la respuesta correcta).";
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "options": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" }
                                    },
                                    "correctAnswer": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "options", "correctAnswer"]
                            }
                        }
                    }
                };

                try {
                    console.log("Attempting to generate questions with Gemini API...");
                    const apiKey = "AIzaSyCUMr9SRpaPJEmB1dhG_g67GZtT8n4_3CI"; // TU CLAVE DE API PROPORCIONADA
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error al generar preguntas con Gemini API:', response.status, response.statusText, errorData);
                        quizContainer.innerHTML = '<p class="text-danger text-center">Error al cargar las preguntas de la IA. Usando preguntas de respaldo. (Código de estado: ' + response.status + ')</p>';
                        questions = defaultQuestions; // Fallback to default questions
                        displayQuiz();
                        return;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        console.log("Gemini API response (raw text):", jsonText);
                        
                        try {
                            questions = JSON.parse(jsonText);
                            console.log("Generated questions:", questions);
                            if (!Array.isArray(questions) || questions.length === 0) { // Check if parsed is not an array or is empty
                                console.warn("Gemini API returned an invalid or empty array of questions. Using fallback questions.");
                                quizContainer.innerHTML = '<p class="text-danger text-center">La IA no generó preguntas válidas. Usando preguntas de respaldo.</p>';
                                questions = defaultQuestions;
                            } else if (questions.length < 30) { // Ensure at least 30 questions, mix if needed
                                console.warn(`Gemini generated ${questions.length} questions. Falling back to default questions to ensure 30 are available.`);
                                questions = defaultQuestions; // Use default if not enough
                            }
                            displayQuiz();
                        } catch (parseError) {
                            console.error('Error al parsear la respuesta JSON de Gemini:', parseError);
                            quizContainer.innerHTML = '<p class="text-danger text-center">Error al procesar preguntas de la IA. Usando preguntas de respaldo.</p>';
                            questions = defaultQuestions;
                            displayQuiz();
                        }
                    } else {
                        console.warn("Gemini API response structure is unexpected (missing content parts). Using fallback questions.");
                        quizContainer.innerHTML = '<p class="text-danger text-center">Estructura de respuesta de IA inesperada. Usando preguntas de respaldo.</p>';
                        questions = defaultQuestions;
                        displayQuiz();
                    }
                } catch (error) {
                    console.error('Error de red o parseo al llamar a Gemini (generar preguntas):', error);
                    quizContainer.innerHTML = '<p class="text-danger text-center">Error de conexión al generar las preguntas. Usando preguntas de respaldo.</p>';
                    questions = defaultQuestions; // Fallback to default questions
                    displayQuiz();
                }
            }

            // Function to display the quiz questions
            function displayQuiz() {
                quizContainer.innerHTML = ''; // Clear loading message
                questions.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.classList.add('question-card');
                    questionCard.innerHTML = `
                        <h5>${index + 1}. ${q.question}</h5>
                        <div class="options-container">
                            ${q.options.map((option, optIndex) => `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="question${index}" id="q${index}opt${optIndex}" value="${option}">
                                    <label class="form-check-label" for="q${index}opt${optIndex}">
                                        ${option}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    quizContainer.appendChild(questionCard);
                });
                quizContainer.style.display = 'block'; // Show quiz container
                submitQuizBtn.style.display = 'block'; // Show submit button
            }

            // Function to submit the quiz and calculate score
            function submitQuiz() {
                let score = 0;
                questions.forEach((q, index) => {
                    const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                    if (selectedOption && selectedOption.value === q.correctAnswer) {
                        score++;
                    }
                });

                const maxScore = questions.length;
                const percentage = (score / maxScore) * 100;
                const grade = calculateGrade(percentage);

                examResults.innerHTML = `
                    <h3>Resultados del Examen</h3>
                    <p>Respuestas correctas: ${score} de ${maxScore}</p>
                    <p>Porcentaje: ${percentage.toFixed(2)}%</p>
                    <p>Tu nota en escala del 1 al 7: <strong>${grade.toFixed(1)}</strong></p>
                    ${grade >= 4.0 ? '<p class="text-success">¡Felicitaciones! Has aprobado.</p>' : '<p class="text-danger">Necesitas repasar más. ¡No te desanimes!</p>'}
                `;
                examResults.style.display = 'block';
                submitQuizBtn.style.display = 'none'; // Hide submit button after submission
                quizContainer.querySelectorAll('input[type="radio"]').forEach(input => input.disabled = true); // Disable options after submission
            }

            // Function to calculate grade from 1 to 7
            function calculateGrade(percentage) {
                // Adjust this scale as needed, this is a basic example
                if (percentage < 30) return 1.0;
                if (percentage < 40) return 2.0;
                if (percentage < 50) return 3.0;
                if (percentage < 60) return 4.0; // Aprobación a partir de 60% (nota 4.0)
                if (percentage < 70) return 5.0;
                if (percentage < 85) return 6.0;
                return 7.0;
            }

            // Event listener for the new "Empezar Examen Ahora" button
            startExamBtn.addEventListener('click', generateQuestions);

            submitQuizBtn.addEventListener('click', submitQuiz);

            // --- AI Clarifier Logic ---
            const aiQuestionInput = document.getElementById('ai-question-input');
            const askAiBtn = document.getElementById('ask-ai-btn');
            const aiClarifierResponse = document.getElementById('ai-clarifier-response');

            askAiBtn.addEventListener('click', async function() {
                const userQuestion = aiQuestionInput.value.trim();
                if (userQuestion === "") {
                    aiClarifierResponse.innerHTML = '<p class="text-danger">Por favor, escribe tu pregunta.</p>';
                    return;
                }

                // Show loading state for AI Clarifier
                aiClarifierResponse.innerHTML = '<p class="text-info">Cargando respuesta de la IA... Esto puede tardar unos segundos.</p>';
                askAiBtn.disabled = true;

                const prompt = `Como un experto en la Ley de Tránsito de Chile (Ley 18.290) y normativas de motocicletas, explica lo siguiente de manera clara y concisa. Si la pregunta es directamente sobre motos, enfócate en esa normativa: "${userQuestion}"`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                try {
                    const apiKey = "AIzaSyCUMr9SRpaPJEmB1dhG_g67GZtT8n4_3CI"; // TU CLAVE DE API PROPORCIONADA
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    console.log("Attempting to get AI clarification with Gemini API for user question:", userQuestion);
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error fetching from Gemini API for clarification:', response.status, response.statusText, errorData);
                        aiClarifierResponse.innerHTML = `<p class="text-danger">Hubo un error (${response.status}) al obtener la respuesta de la IA. Por favor, inténtalo de nuevo.</p>`;
                        return;
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        aiClarifierResponse.innerHTML = `<p>${text}</p>`;
                    } else {
                        console.warn("Gemini API clarification response structure is unexpected or empty.");
                        aiClarifierResponse.innerHTML = '<p class="text-warning">No se pudo obtener una respuesta clara de la IA. Intenta reformular tu pregunta.</p>';
                    }
                } catch (error) {
                    console.error('Network error or parsing issue in Gemini API call for clarification:', error);
                    aiClarifierResponse.innerHTML = '<p class="text-danger">Error de conexión al Clarificador IA. Asegúrate de tener acceso a internet y que el servicio esté disponible.</p>';
                } finally {
                    askAiBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
